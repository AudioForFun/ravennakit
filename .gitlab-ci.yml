variables:
  GIT_SUBMODULE_STRATEGY: recursive
  GIT_DEPTH: 50
  
stages:        
  - build

build-macos:  
  variables:
    CI_DEBUG_TRACE: "true"
  tags:
    - macos
  stage: build
  script:
    - export ASAN_OPTIONS=detect_container_overflow=0 # Disable ASAN container overflow detection
    - brew install pkg-config ninja
    - python3 -m pip install pygit2 boto3
    - python3 -u build.py --path-to-build build-macos --build-number $CI_PIPELINE_IID --asan --tsan

build-windows:  
  variables:
    CI_DEBUG_TRACE: "true"
  tags:
    - windows
  stage: build
  script:
    - python -m pip install pygit2 boto3
    - python -u build.py --path-to-build build-windows --build-number "$env:CI_PIPELINE_IID"

build-linux:  
  tags:
    - docker
  stage: build
  image: gcc:latest
  script:
    - apt-get update -y
    - apt-get -y install python3-venv build-essential cmake ninja-build pkg-config python3-pip zip unzip
    - python3 -m venv .venv
    - source .venv/bin/activate
    - python3 -m pip install pygit2 boto3
    - python3 -u build.py --path-to-build build-linux --build-number $CI_PIPELINE_IID

build-android:  
  tags:
    - macos
  stage: build
  script:
    - python3 -m pip install pygit2 boto3
    - python3 -u build.py --android --path-to-build build-android --build-number "$env:CI_PIPELINE_IID"

build-dist:
  tags:
    - macos
  stage: build
  script:
    - python3 -m pip install pygit2 boto3
    - brew install doxygen
    - git submodule update --recursive --init
    - python3 -m pip install pygit2 boto3 requests
    - python3 -u build.py --dist --path-to-build build-dist --build-number $CI_PIPELINE_IID --upload --spaces-key $SPACES_KEY --spaces-secret $SPACES_SECRET
